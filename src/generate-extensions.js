/**
 * Generate extension files for cht-conf auto-include
 *
 * Creates:
 * - stock-monitoring.tasks.js (auto-included by cht-conf)
 * - stock-monitoring.contact-summary.js (auto-included by cht-conf)
 */
const fs = require('fs-extra');
const path = require('path');
const chalk = require('chalk');

const TASKS_EXTENSION_FILENAME = 'stock-monitoring.tasks.js';
const CONTACT_SUMMARY_EXTENSION_FILENAME = 'stock-monitoring.contact-summary.js';
const CONFIG_FILENAME = 'stock-monitoring.config.json';

/**
 * Generate the tasks extension file content
 * @returns {string} JavaScript file content
 */
function getTasksExtensionContent() {
  return `/**
 * Stock Monitoring Tasks Extension
 * Auto-generated by cht-stock-monitoring-workflow
 *
 * This file is auto-included by cht-conf during compilation.
 * Do not edit manually - changes will be overwritten on next build.
 */
const stockMonitoringConfigs = require('./${CONFIG_FILENAME}');
const { getStockMonitoringTasks } = require('@medic/cht-stock-monitoring-workflow');

module.exports = getStockMonitoringTasks(stockMonitoringConfigs);
`;
}

/**
 * Generate the contact-summary extension file content
 * @returns {string} JavaScript file content
 */
function getContactSummaryExtensionContent() {
  return `/**
 * Stock Monitoring Contact Summary Cards Extension
 * Auto-generated by cht-stock-monitoring-workflow
 *
 * This file is auto-included by cht-conf during compilation.
 * Do not edit manually - changes will be overwritten on next build.
 */
const stockMonitoringConfigs = require('./${CONFIG_FILENAME}');
const { getStockMonitoringSummaryCards } = require('@medic/cht-stock-monitoring-workflow');

module.exports = {
  cards: getStockMonitoringSummaryCards(stockMonitoringConfigs, reports)
};
`;
}

/**
 * Generate extension files for auto-include
 * @param {string} projectDir - Project directory path (defaults to cwd)
 */
function generateExtensions(projectDir = process.cwd()) {
  const tasksPath = path.join(projectDir, TASKS_EXTENSION_FILENAME);
  const contactSummaryPath = path.join(projectDir, CONTACT_SUMMARY_EXTENSION_FILENAME);

  // Generate tasks extension
  fs.writeFileSync(tasksPath, getTasksExtensionContent());
  console.log(chalk.green(`INFO Generated ${TASKS_EXTENSION_FILENAME}`));

  // Generate contact-summary extension
  fs.writeFileSync(contactSummaryPath, getContactSummaryExtensionContent());
  console.log(chalk.green(`INFO Generated ${CONTACT_SUMMARY_EXTENSION_FILENAME}`));

  console.log(chalk.blue(`INFO These files will be auto-included by cht-conf during compilation`));
}

module.exports = {
  generateExtensions,
  TASKS_EXTENSION_FILENAME,
  CONTACT_SUMMARY_EXTENSION_FILENAME,
};
