# PostgreSQL Schema for CHT Stock Monitoring

This document describes how to work with CHT Stock Monitoring data in PostgreSQL when using cht-sync/couch2pg for data synchronization.

## Table of Contents

1. [Current Schema (Wide Tables)](#current-schema-wide-tables)
2. [Recommended Schema (Long Tables)](#recommended-schema-long-tables)
3. [Transformation Views](#transformation-views)
4. [Document Type Mapping](#document-type-mapping)
5. [Common Queries](#common-queries)

---

## Current Schema (Wide Tables)

When CHT forms are synced to PostgreSQL via couch2pg, the data arrives in a "wide" format where each stock item becomes its own column. This implicit schema is derived from the field names generated by the stock monitoring workflow.

### Field Naming Conventions

The stock monitoring workflow generates the following field patterns for each item:

| Form Type | Field Pattern | Description |
|-----------|---------------|-------------|
| stock_count | `{item_name}` | User input (integer or set format) |
| stock_count | `{item_name}___count` | Calculated total units |
| stock_count | `{item_name}___set` | Number of sets (for set-based items) |
| stock_count | `{item_name}___unit` | Number of loose units (for set-based items) |
| stock_count | `{item_name}_availables` | Available quantity (export calculation) |
| stock_supply | `supply_{item_name}` | Quantity being supplied |
| stock_supply | `{item_name}___count` | Calculated total units supplied |
| stock_supply | `{item_name}_supply` | Export calculation for supply |
| stock_supply | `{item_name}_in` | Additional doc field for incoming stock |
| stock_received | `{item_name}_received` | Quantity expected to receive |
| stock_received | `{item_name}_real_qty` | Actual quantity received (if different) |
| stock_received | `{item_name}_confirmed` | Final confirmed quantity |
| stock_out | `{item_name}_required` | Required stock level |
| stock_out | `{item_name}_at_hand` | Current stock at hand |
| stock_return | `{item_name}_current` | Current stock before return |
| stock_return | `{item_name}_returned_qty` | Quantity being returned |
| stock_return | `{item_name}_out` | Export calculation for outgoing stock |
| stock_return | `{item_name}_after` | Stock level after return |

### Example: stock_count Form Table

```sql
-- Implicit schema when synced via couch2pg
-- Note: This is what you get automatically, not what you should create

CREATE TABLE IF NOT EXISTS couchdb_forms_stock_count (
    _id TEXT PRIMARY KEY,
    _rev TEXT,
    form TEXT,
    type TEXT,
    reported_date BIGINT,

    -- Contact/facility information
    contact_id TEXT,
    place_id TEXT,

    -- Hidden inputs
    date_id TEXT,

    -- Per-item fields (repeated for each stock item)
    -- Example for item "paracetamol":
    paracetamol TEXT,                    -- User input (e.g., "2/3" for sets)
    paracetamol___set INTEGER,           -- Parsed set count
    paracetamol___unit INTEGER,          -- Parsed unit count
    paracetamol___count INTEGER,         -- Total units calculated
    paracetamol_availables INTEGER,      -- Export field

    -- Example for item "amoxicillin":
    amoxicillin INTEGER,                 -- User input (simple integer)
    amoxicillin___count INTEGER,         -- Total units (same as input)
    amoxicillin_availables INTEGER,      -- Export field

    -- ... repeated for each configured item

    -- Metadata
    geolocation JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Example: stock_supply Form Table

```sql
-- Implicit schema for stock supply forms

CREATE TABLE IF NOT EXISTS couchdb_forms_stock_supply (
    _id TEXT PRIMARY KEY,
    _rev TEXT,
    form TEXT,
    type TEXT,
    reported_date BIGINT,

    -- Contact/facility information
    contact_id TEXT,
    place_id TEXT,
    supply_place_id TEXT,
    user_contact_id TEXT,

    -- Category selection (if using categories)
    categories TEXT,                      -- Multi-select: "malaria,nutrition"

    -- Per-category item selection
    malaria_items_selected TEXT,          -- Selected items in category

    -- Per-item fields (repeated for each stock item)
    -- Example for item "paracetamol":
    supply_paracetamol TEXT,             -- User input
    paracetamol___set INTEGER,           -- Parsed set count
    paracetamol___unit INTEGER,          -- Parsed unit count
    paracetamol___count INTEGER,         -- Total units calculated
    paracetamol_supply INTEGER,          -- Export field
    paracetamol_current INTEGER,         -- Current stock at destination

    -- ... repeated for each configured item

    created_at TIMESTAMP DEFAULT NOW()
);
```

### Problems with Wide Tables

1. **Schema volatility**: Adding or removing stock items requires schema changes
2. **Sparse data**: Most rows have NULL values for items not involved in the transaction
3. **Query complexity**: Aggregating across items requires listing every column
4. **Maintenance burden**: Reports and queries must be updated when items change
5. **Storage inefficiency**: Many NULL columns waste storage space

---

## Recommended Schema (Long Tables)

A normalized "long" format is recommended for analytics and reporting. This approach stores one row per item per transaction, making queries simpler and schema changes unnecessary when items are added or removed.

### Core Transaction Table

```sql
-- Normalized stock transactions table
CREATE TABLE sm_transactions (
    id SERIAL PRIMARY KEY,
    doc_id TEXT NOT NULL,
    form_type TEXT NOT NULL,
    item_code TEXT NOT NULL,
    qty_in INTEGER DEFAULT 0,
    qty_out INTEGER DEFAULT 0,
    qty_on_hand INTEGER,
    reported_date TIMESTAMP NOT NULL,
    facility_id TEXT,
    submitter_id TEXT,
    supplier_id TEXT,
    parent_facility_id TEXT,
    category TEXT,
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),

    CONSTRAINT valid_qty CHECK (qty_in >= 0 AND qty_out >= 0)
);

-- Indexes for common query patterns
CREATE INDEX idx_sm_transactions_doc_id ON sm_transactions(doc_id);
CREATE INDEX idx_sm_transactions_form_type ON sm_transactions(form_type);
CREATE INDEX idx_sm_transactions_item_code ON sm_transactions(item_code);
CREATE INDEX idx_sm_transactions_reported_date ON sm_transactions(reported_date);
CREATE INDEX idx_sm_transactions_facility_id ON sm_transactions(facility_id);
CREATE INDEX idx_sm_transactions_submitter_id ON sm_transactions(submitter_id);

-- Composite index for facility + date range queries
CREATE INDEX idx_sm_transactions_facility_date
    ON sm_transactions(facility_id, reported_date);

-- Composite index for item + date range queries
CREATE INDEX idx_sm_transactions_item_date
    ON sm_transactions(item_code, reported_date);
```

### Stock Item Reference Table

```sql
-- Reference table for stock items (sync from config)
CREATE TABLE sm_items (
    item_code TEXT PRIMARY KEY,
    item_name TEXT NOT NULL,
    category TEXT,
    unit_name TEXT,
    set_name TEXT,
    units_per_set INTEGER DEFAULT 1,
    warning_threshold INTEGER,
    danger_threshold INTEGER,
    max_stock INTEGER,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sm_items_category ON sm_items(category);
CREATE INDEX idx_sm_items_active ON sm_items(is_active);
```

### Facility Reference Table

```sql
-- Reference table for facilities
CREATE TABLE sm_facilities (
    facility_id TEXT PRIMARY KEY,
    facility_name TEXT,
    facility_type TEXT,
    parent_facility_id TEXT,
    contact_id TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),

    FOREIGN KEY (parent_facility_id) REFERENCES sm_facilities(facility_id)
);

CREATE INDEX idx_sm_facilities_parent ON sm_facilities(parent_facility_id);
CREATE INDEX idx_sm_facilities_type ON sm_facilities(facility_type);
```

### Current Stock Levels (Materialized View)

```sql
-- Materialized view for current stock levels per facility
CREATE MATERIALIZED VIEW sm_current_stock AS
SELECT
    facility_id,
    item_code,
    SUM(qty_in) - SUM(qty_out) AS current_qty,
    MAX(reported_date) AS last_transaction_date,
    COUNT(*) AS transaction_count
FROM sm_transactions
GROUP BY facility_id, item_code;

CREATE UNIQUE INDEX idx_sm_current_stock_pk
    ON sm_current_stock(facility_id, item_code);

-- Refresh periodically (e.g., via cron job or after ETL)
-- REFRESH MATERIALIZED VIEW CONCURRENTLY sm_current_stock;
```

---

## Transformation Views

These views transform the wide CouchDB data into the normalized long format. They use UNNEST patterns to dynamically handle any number of stock items.

### Generic Item Extraction Function

```sql
-- Helper function to extract item quantities from JSONB
CREATE OR REPLACE FUNCTION extract_stock_items(
    doc JSONB,
    suffix TEXT,
    form_type TEXT
) RETURNS TABLE (
    item_code TEXT,
    quantity INTEGER
) AS $$
DECLARE
    key TEXT;
    value JSONB;
    item_name TEXT;
BEGIN
    FOR key, value IN SELECT * FROM jsonb_each(doc)
    LOOP
        -- Match fields ending with the specified suffix
        IF key LIKE '%' || suffix THEN
            item_name := regexp_replace(key, suffix || '$', '');
            -- Skip internal fields
            IF item_name NOT LIKE '%___%' AND item_name != '' THEN
                RETURN QUERY SELECT
                    item_name::TEXT,
                    COALESCE((value #>> '{}')::INTEGER, 0);
            END IF;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### View: Stock Count Transactions

```sql
-- Transform stock_count forms to normalized transactions
CREATE OR REPLACE VIEW v_stock_count_transactions AS
WITH item_data AS (
    SELECT
        doc->>'_id' AS doc_id,
        'stock_count' AS form_type,
        to_timestamp((doc->>'reported_date')::BIGINT / 1000) AS reported_date,
        doc->>'place_id' AS facility_id,
        doc->'contact'->>'_id' AS submitter_id,
        key AS field_name,
        value
    FROM couchdb
    CROSS JOIN LATERAL jsonb_each(doc->'fields')
    WHERE doc->>'form' = 'stock_count'
      AND key LIKE '%_availables'
)
SELECT
    doc_id,
    form_type,
    regexp_replace(field_name, '_availables$', '') AS item_code,
    COALESCE((value #>> '{}')::INTEGER, 0) AS qty_on_hand,
    0 AS qty_in,
    0 AS qty_out,
    reported_date,
    facility_id,
    submitter_id,
    NULL::TEXT AS supplier_id
FROM item_data
WHERE (value #>> '{}')::INTEGER IS NOT NULL;
```

### View: Stock Supply Transactions

```sql
-- Transform stock_supply forms to normalized transactions
CREATE OR REPLACE VIEW v_stock_supply_transactions AS
WITH item_data AS (
    SELECT
        doc->>'_id' AS doc_id,
        'stock_supply' AS form_type,
        to_timestamp((doc->>'reported_date')::BIGINT / 1000) AS reported_date,
        doc->'fields'->>'supply_place_id' AS facility_id,
        doc->'contact'->>'_id' AS submitter_id,
        doc->'fields'->>'user_contact_id' AS supplier_id,
        key AS field_name,
        value
    FROM couchdb
    CROSS JOIN LATERAL jsonb_each(doc->'fields')
    WHERE doc->>'form' = 'stock_supply'
      AND key LIKE '%_supply'
)
SELECT
    doc_id,
    form_type,
    regexp_replace(field_name, '_supply$', '') AS item_code,
    NULL::INTEGER AS qty_on_hand,
    COALESCE((value #>> '{}')::INTEGER, 0) AS qty_in,
    0 AS qty_out,
    reported_date,
    facility_id,
    submitter_id,
    supplier_id
FROM item_data
WHERE (value #>> '{}')::INTEGER > 0;
```

### View: Stock Received Transactions

```sql
-- Transform stock_received (confirmation) forms to normalized transactions
CREATE OR REPLACE VIEW v_stock_received_transactions AS
WITH item_data AS (
    SELECT
        doc->>'_id' AS doc_id,
        'stock_received' AS form_type,
        to_timestamp((doc->>'reported_date')::BIGINT / 1000) AS reported_date,
        doc->>'place_id' AS facility_id,
        doc->'contact'->>'_id' AS submitter_id,
        doc->'fields'->>'supplier_id' AS supplier_id,
        key AS field_name,
        value
    FROM couchdb
    CROSS JOIN LATERAL jsonb_each(doc->'fields')
    WHERE doc->>'form' IN ('stock_received', 'stock_confirmation')
      AND key LIKE '%_confirmed'
)
SELECT
    doc_id,
    form_type,
    regexp_replace(field_name, '_confirmed$', '') AS item_code,
    NULL::INTEGER AS qty_on_hand,
    COALESCE((value #>> '{}')::INTEGER, 0) AS qty_in,
    0 AS qty_out,
    reported_date,
    facility_id,
    submitter_id,
    supplier_id
FROM item_data
WHERE (value #>> '{}')::INTEGER > 0;
```

### View: Stock Return Transactions

```sql
-- Transform stock_return forms to normalized transactions
CREATE OR REPLACE VIEW v_stock_return_transactions AS
WITH item_data AS (
    SELECT
        doc->>'_id' AS doc_id,
        'stock_return' AS form_type,
        to_timestamp((doc->>'reported_date')::BIGINT / 1000) AS reported_date,
        doc->>'place_id' AS facility_id,
        doc->'contact'->>'_id' AS submitter_id,
        key AS field_name,
        value
    FROM couchdb
    CROSS JOIN LATERAL jsonb_each(doc->'fields')
    WHERE doc->>'form' = 'stock_return'
      AND key LIKE '%_out'
)
SELECT
    doc_id,
    form_type,
    regexp_replace(field_name, '_out$', '') AS item_code,
    NULL::INTEGER AS qty_on_hand,
    0 AS qty_in,
    COALESCE((value #>> '{}')::INTEGER, 0) AS qty_out,
    reported_date,
    facility_id,
    submitter_id,
    NULL::TEXT AS supplier_id
FROM item_data
WHERE (value #>> '{}')::INTEGER > 0;
```

### Unified Transactions View

```sql
-- Combine all transaction types into a single view
CREATE OR REPLACE VIEW v_all_stock_transactions AS
SELECT * FROM v_stock_count_transactions
UNION ALL
SELECT * FROM v_stock_supply_transactions
UNION ALL
SELECT * FROM v_stock_received_transactions
UNION ALL
SELECT * FROM v_stock_return_transactions;
```

### ETL Procedure: Load Transactions

```sql
-- Procedure to load transformed data into the normalized table
CREATE OR REPLACE PROCEDURE load_stock_transactions(
    p_since_date TIMESTAMP DEFAULT NULL
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- Delete existing records for documents being reprocessed
    IF p_since_date IS NOT NULL THEN
        DELETE FROM sm_transactions
        WHERE reported_date >= p_since_date;
    END IF;

    -- Insert new transactions
    INSERT INTO sm_transactions (
        doc_id, form_type, item_code, qty_in, qty_out,
        qty_on_hand, reported_date, facility_id, submitter_id, supplier_id
    )
    SELECT
        doc_id, form_type, item_code, qty_in, qty_out,
        qty_on_hand, reported_date, facility_id, submitter_id, supplier_id
    FROM v_all_stock_transactions
    WHERE p_since_date IS NULL OR reported_date >= p_since_date
    ON CONFLICT (doc_id) DO UPDATE SET
        qty_in = EXCLUDED.qty_in,
        qty_out = EXCLUDED.qty_out,
        qty_on_hand = EXCLUDED.qty_on_hand;

    -- Refresh materialized view
    REFRESH MATERIALIZED VIEW CONCURRENTLY sm_current_stock;
END;
$$;
```

---

## Document Type Mapping

Different form configurations may use different form names. This view normalizes document types to standard categories.

### Form Type Normalization View

```sql
-- Normalize form names to standard types
CREATE OR REPLACE VIEW v_form_type_mapping AS
SELECT
    doc->>'_id' AS doc_id,
    doc->>'form' AS original_form,
    CASE
        -- Stock count forms
        WHEN doc->>'form' LIKE '%stock_count%' THEN 'stock_count'
        WHEN doc->>'form' LIKE '%inventory%' THEN 'stock_count'
        WHEN doc->>'form' LIKE '%balance%' THEN 'stock_count'

        -- Stock supply forms (outgoing from supplier perspective)
        WHEN doc->>'form' LIKE '%stock_supply%' THEN 'stock_supply'
        WHEN doc->>'form' LIKE '%supply%' AND doc->>'form' NOT LIKE '%received%' THEN 'stock_supply'
        WHEN doc->>'form' LIKE '%distribute%' THEN 'stock_supply'

        -- Stock received forms (incoming from receiver perspective)
        WHEN doc->>'form' LIKE '%stock_received%' THEN 'stock_received'
        WHEN doc->>'form' LIKE '%stock_confirmation%' THEN 'stock_received'
        WHEN doc->>'form' LIKE '%confirm%supply%' THEN 'stock_received'

        -- Stock return forms
        WHEN doc->>'form' LIKE '%stock_return%' THEN 'stock_return'
        WHEN doc->>'form' LIKE '%return%' THEN 'stock_return'

        -- Stock returned (confirmation of return)
        WHEN doc->>'form' LIKE '%stock_returned%' THEN 'stock_returned'

        -- Stock out alerts
        WHEN doc->>'form' LIKE '%stock_out%' THEN 'stock_out'
        WHEN doc->>'form' LIKE '%stockout%' THEN 'stock_out'

        -- Stock discrepancy
        WHEN doc->>'form' LIKE '%discrepancy%' THEN 'stock_discrepancy'

        -- Stock order
        WHEN doc->>'form' LIKE '%stock_order%' THEN 'stock_order'
        WHEN doc->>'form' LIKE '%order%' THEN 'stock_order'

        ELSE 'unknown'
    END AS normalized_form_type,
    CASE
        WHEN doc->>'form' LIKE '%stock_count%' THEN 'Balance on hand snapshot'
        WHEN doc->>'form' LIKE '%stock_supply%' THEN 'Stock sent to facility'
        WHEN doc->>'form' LIKE '%stock_received%' THEN 'Stock received confirmation'
        WHEN doc->>'form' LIKE '%stock_return%' THEN 'Stock returned to supplier'
        WHEN doc->>'form' LIKE '%stock_out%' THEN 'Stock out alert'
        WHEN doc->>'form' LIKE '%discrepancy%' THEN 'Discrepancy resolution'
        WHEN doc->>'form' LIKE '%stock_order%' THEN 'Stock order request'
        ELSE 'Unknown form type'
    END AS description
FROM couchdb
WHERE doc->>'type' = 'data_record';
```

### Form Type Reference Table

```sql
-- Reference table for form types
CREATE TABLE IF NOT EXISTS sm_form_types (
    form_type TEXT PRIMARY KEY,
    display_name TEXT NOT NULL,
    description TEXT,
    affects_qty_in BOOLEAN DEFAULT FALSE,
    affects_qty_out BOOLEAN DEFAULT FALSE,
    affects_on_hand BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

INSERT INTO sm_form_types (form_type, display_name, description, affects_qty_in, affects_qty_out, affects_on_hand)
VALUES
    ('stock_count', 'Stock Count', 'Balance on hand snapshot', FALSE, FALSE, TRUE),
    ('stock_supply', 'Stock Supply', 'Stock sent from supplier to facility', TRUE, FALSE, FALSE),
    ('stock_received', 'Stock Received', 'Confirmation of stock received', TRUE, FALSE, FALSE),
    ('stock_return', 'Stock Return', 'Stock returned to supplier', FALSE, TRUE, FALSE),
    ('stock_returned', 'Stock Returned', 'Confirmation of returned stock received', FALSE, TRUE, FALSE),
    ('stock_out', 'Stock Out', 'Alert for low/out of stock', FALSE, FALSE, FALSE),
    ('stock_discrepancy', 'Stock Discrepancy', 'Resolution of supply discrepancy', TRUE, FALSE, FALSE),
    ('stock_order', 'Stock Order', 'Request for stock resupply', FALSE, FALSE, FALSE)
ON CONFLICT (form_type) DO NOTHING;
```

---

## Common Queries

### Current Stock Levels by Facility

```sql
-- Current stock levels with threshold status
SELECT
    f.facility_name,
    i.item_name,
    i.category,
    cs.current_qty,
    i.warning_threshold,
    i.danger_threshold,
    CASE
        WHEN cs.current_qty <= i.danger_threshold THEN 'CRITICAL'
        WHEN cs.current_qty <= i.warning_threshold THEN 'WARNING'
        ELSE 'OK'
    END AS stock_status,
    cs.last_transaction_date
FROM sm_current_stock cs
JOIN sm_items i ON cs.item_code = i.item_code
JOIN sm_facilities f ON cs.facility_id = f.facility_id
WHERE i.is_active = TRUE
ORDER BY
    CASE
        WHEN cs.current_qty <= i.danger_threshold THEN 1
        WHEN cs.current_qty <= i.warning_threshold THEN 2
        ELSE 3
    END,
    f.facility_name,
    i.item_name;
```

### Stock Movement Summary by Period

```sql
-- Monthly stock movement summary
SELECT
    DATE_TRUNC('month', reported_date) AS month,
    item_code,
    form_type,
    SUM(qty_in) AS total_in,
    SUM(qty_out) AS total_out,
    COUNT(*) AS transaction_count
FROM sm_transactions
WHERE reported_date >= NOW() - INTERVAL '12 months'
GROUP BY DATE_TRUNC('month', reported_date), item_code, form_type
ORDER BY month DESC, item_code, form_type;
```

### Facility Resupply Needs

```sql
-- Facilities needing resupply
SELECT
    f.facility_name,
    i.item_name,
    cs.current_qty,
    i.max_stock,
    i.max_stock - cs.current_qty AS qty_needed,
    cs.last_transaction_date
FROM sm_current_stock cs
JOIN sm_items i ON cs.item_code = i.item_code
JOIN sm_facilities f ON cs.facility_id = f.facility_id
WHERE cs.current_qty < i.warning_threshold
  AND i.is_active = TRUE
ORDER BY
    (cs.current_qty::FLOAT / NULLIF(i.danger_threshold, 0)) ASC,
    f.facility_name;
```

### Transaction Audit Trail

```sql
-- Full transaction history for an item at a facility
SELECT
    t.reported_date,
    t.form_type,
    t.qty_in,
    t.qty_out,
    t.qty_on_hand,
    SUM(t.qty_in - t.qty_out) OVER (
        PARTITION BY t.facility_id, t.item_code
        ORDER BY t.reported_date
    ) AS running_balance,
    t.submitter_id,
    t.supplier_id,
    t.doc_id
FROM sm_transactions t
WHERE t.facility_id = 'facility_123'
  AND t.item_code = 'paracetamol'
ORDER BY t.reported_date DESC;
```

### Stock Consumption Rate

```sql
-- Average daily consumption by item
WITH daily_consumption AS (
    SELECT
        item_code,
        DATE(reported_date) AS report_date,
        SUM(qty_out) AS daily_out
    FROM sm_transactions
    WHERE form_type IN ('stock_return', 'consumption')
      AND reported_date >= NOW() - INTERVAL '30 days'
    GROUP BY item_code, DATE(reported_date)
)
SELECT
    item_code,
    AVG(daily_out) AS avg_daily_consumption,
    MAX(daily_out) AS max_daily_consumption,
    COUNT(DISTINCT report_date) AS days_with_activity
FROM daily_consumption
GROUP BY item_code
ORDER BY avg_daily_consumption DESC;
```

---

## Notes

1. **couch2pg Sync**: The wide table schema is automatically created by couch2pg based on the CouchDB document structure. The normalized schema requires additional ETL steps.

2. **Performance**: For large datasets, consider partitioning `sm_transactions` by `reported_date` and using appropriate indexes.

3. **Refresh Strategy**: The `sm_current_stock` materialized view should be refreshed after each ETL run or on a regular schedule (e.g., hourly).

4. **Item Configuration**: Keep `sm_items` synchronized with your stock monitoring configuration to ensure threshold values are current.

5. **Field Name Variations**: Different installations may customize form and field names. Adjust the transformation views and mappings accordingly.
